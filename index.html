<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o B√†i T·∫≠p To√°n: T·ªïng v√† Hi·ªáu</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C·∫•u h√¨nh Font v√† M√†u s·∫Øc -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Serif:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container-card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loading-animation {
            border-top: 4px solid #3498db;
            border-right: 4px solid transparent;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        /* Loading animation cho Quiz (m√†u t√≠m) */
        .loading-animation.border-purple-500 {
            border-top: 4px solid #9333ea;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* S·ª≠ d·ª•ng font Serif cho ph·∫ßn ƒë·ªÅ b√†i ƒë·ªÉ t·∫°o c·∫£m gi√°c h·ªçc thu·∫≠t */
        #problem-text, #quiz-problem-text {
            font-family: 'Noto Serif', serif;
        }
        /* N√∫t l·ª±a ch·ªçn Quiz/B√†i t·∫≠p chi ti·∫øt */
        .choice-btn:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div class="w-full max-w-4xl container-card bg-white rounded-xl p-6 md:p-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-indigo-700 mb-6 border-b-4 border-indigo-200 pb-3 flex items-center justify-center space-x-3">
            <span class="text-4xl">üìö</span>
            <span>T·∫°o B√†i T·∫≠p To√°n Ti·ªÉu H·ªçc</span>
            <span class="text-4xl">‚úèÔ∏è</span>
        </h1>
        <p class="text-center text-gray-600 mb-8">Ch·ªß ƒë·ªÅ: T√¨m hai s·ªë khi bi·∫øt T·ªïng v√† Hi·ªáu (S√°ch GK 2018)</p>

        <!-- KHU V·ª∞C C·∫§U H√åNH B√ÄI T·∫¨P -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

            <!-- 1. Ch·ªçn M·ª©c ƒê·ªô -->
            <div class="col-span-3 md:col-span-3">
                <label class="block text-lg font-semibold text-gray-700 mb-2">1. Ch·ªçn M·ª©c ƒê·ªô Kh√≥:</label>
                <div id="level-selection" class="flex flex-wrap gap-3">
                    <button data-level="Bi·∫øt" class="level-btn px-4 py-2 rounded-full font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-green-500 hover:text-white">
                        Bi·∫øt (D·ªÖ)
                    </button>
                    <button data-level="Hi·ªÉu" class="level-btn px-4 py-2 rounded-full font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-yellow-500 hover:text-white">
                        Hi·ªÉu (Trung b√¨nh)
                    </button>
                    <button data-level="V·∫≠n d·ª•ng" class="level-btn px-4 py-2 rounded-full font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-red-500 hover:text-white">
                        V·∫≠n d·ª•ng (Kh√≥)
                    </button>
                </div>
            </div>
            
            <!-- 2. Ch·ªçn Lo·∫°i B√†i T·∫≠p -->
            <div class="col-span-3 md:col-span-3">
                <label class="block text-lg font-semibold text-gray-700 mb-2">2. Ch·ªçn Lo·∫°i B√†i T·∫≠p:</label>
                <div id="type-selection" class="flex flex-wrap gap-3">
                    <button data-type="Th·ª±c t·∫ø" class="type-btn px-4 py-2 rounded-full font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-teal-500 hover:text-white">
                        To√°n Th·ª±c T·∫ø (B√†i to√°n ƒë·ªë)
                    </button>
                    <button data-type="Ph√©p t√≠nh" class="type-btn px-4 py-2 rounded-full font-medium transition duration-200 bg-gray-200 text-gray-700 hover:bg-teal-500 hover:text-white">
                        Ph√©p T√≠nh B√¨nh Th∆∞·ªùng
                    </button>
                </div>
            </div>

            <!-- 3. Nh·∫≠p Ng·ªØ C·∫£nh T√πy Ch·ªânh -->
            <div class="col-span-3">
                <label for="context-input" class="block text-lg font-semibold text-gray-700 mb-2">3. Nh·∫≠p Ng·ªØ C·∫£nh (Tu·ª≥ ch·ªçn - Ch·ªâ √°p d·ª•ng cho To√°n Th·ª±c T·∫ø):</label>
                <input type="text" id="context-input" placeholder="V√≠ d·ª•: ·ªû trang tr·∫°i, v·ªÅ tr√≤ ch∆°i ƒëi·ªán t·ª≠, v·ªÅ ƒë·ªì v·∫≠t h·ªçc sinh..." 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                <p class="text-sm text-gray-500 mt-1">Ng·ªØ c·∫£nh gi√∫p b√†i to√°n h·∫•p d·∫´n v√† g·∫ßn g≈©i h∆°n v·ªõi h·ªçc sinh.</p>
            </div>
        </div>

        <!-- N√öT T·∫†O B√ÄI T·∫¨P V√Ä QUIZ (C·∫≠p nh·∫≠t b·ªë c·ª•c) -->
        <div class="flex flex-col lg:flex-row gap-4">
            <button id="generate-btn" 
                    class="choice-btn w-full lg:w-1/2 flex items-center justify-center space-x-2 px-6 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01] disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l7.5 7.5a.75.75 0 1 1-1.06 1.06l-6.22-6.22V20.5a.75.75 0 0 1-1.5 0V4.81l-6.22 6.22a.75.75 0 1 1-1.06-1.06l7.5-7.5Z" clip-rule="evenodd" />
                </svg>
                <span>T·∫°o B√†i T·∫≠p Chi Ti·∫øt</span>
            </button>
            <!-- N√∫t T·∫°o Quiz -->
            <button id="quiz-btn" 
                    class="choice-btn w-full lg:w-1/2 flex items-center justify-center space-x-2 px-6 py-3 bg-purple-600 text-white text-xl font-bold rounded-xl hover:bg-purple-700 transition duration-300 transform hover:scale-[1.01] shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M14.615 1.595a.75.75 0 0 1 .359.852L12.982 7.5H19.5a.75.75 0 0 1 .581 1.258l-10.75 14.25a.75.75 0 0 1-1.127-.25l-.847-2.094a.75.75 0 0 1 .442-.984l.732-.293H9.75a.75.75 0 0 1 .581 1.259l-2.001 2.668 10.05-13.4a.75.75 0 0 1-.359-.852l1.282-4.269 1.282 4.269a.75.75 0 0 1-.359.852l-1.282 4.269L5.438 18.258a.75.75 0 0 1-1.127-.25L3.461 15.91a.75.75 0 0 1 .442-.984l.732-.293H4.5a.75.75 0 0 1 .581 1.259l2.001 2.668 10.05-13.4Z" clip-rule="evenodd" />
                </svg>
                <span>T·∫°o QUIZ (Tr·∫Øc nghi·ªám)</span>
            </button>
        </div>
        
        <!-- KHU V·ª∞C K·∫æT QU·∫¢ V√Ä TH√îNG B√ÅO -->
        <div id="status-message" class="text-center mt-4 text-sm font-medium text-red-600 hidden"></div>
        <div id="loading-indicator" class="flex justify-center items-center h-16 mt-8 hidden">
            <div class="loading-animation"></div>
            <!-- C·∫≠p nh·∫≠t th√¥ng b√°o t·∫£i chi ti·∫øt -->
            <span class="ml-3 text-lg font-medium text-indigo-600">ƒêang so·∫°n ƒë·ªÅ v√† l·ªùi gi·∫£i... Vui l√≤ng ch·ªù.</span>
        </div>
        
        <!-- KHU V·ª∞C HI·ªÇN TH·ªä B√ÄI T·∫¨P - UI TR·ª∞C QUAN H∆†N -->
        <div id="result-area" class="mt-8 pt-6 border-t-2 border-dashed border-gray-300 hidden">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex justify-between items-center">
                <span>B√†i T·∫≠p ƒê√£ T·∫°o (Lo·∫°i: Chi ti·∫øt)</span>
                <span id="level-badge" class="px-3 py-1 text-sm font-semibold rounded-full"></span>
            </h2>

            <!-- Problem Box Enhancement: N·ªïi b·∫≠t h∆°n v·ªõi vi·ªÅn d√†y v√† font serif -->
            <div class="bg-white p-5 rounded-xl border-4 border-indigo-400 shadow-lg mb-6">
                <h3 class="text-xl font-extrabold text-indigo-700 border-b pb-2 mb-3 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                      <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75H16.5a.75.75 0 0 0 0-1.5H12.75V6Z" clip-rule="evenodd" />
                    </svg>
                    <span>ƒê·ªÅ B√†i (M·ª©c: <span id="current-level" class="text-indigo-500"></span>)</span>
                </h3>
                <p id="problem-text" class="text-gray-900 text-xl leading-relaxed whitespace-pre-wrap"></p>
            </div>

            <!-- Solution Box Enhancement: M√†u xanh l√° n·ªïi b·∫≠t, c√≥ ti√™u ƒë·ªÅ b∆∞·ªõc gi·∫£i -->
            <details class="bg-white border-2 border-green-500 rounded-xl overflow-hidden shadow-lg">
                <summary class="p-4 bg-green-50 cursor-pointer text-green-700 text-xl font-bold transition duration-150 hover:bg-green-100 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.037 2.036a.75.75 0 0 0 1.06-.01l3.77-5.28Z" clip-rule="evenodd" />
                    </svg>
                    <span>Xem L·ªùi Gi·∫£i Chi Ti·∫øt</span>
                </summary>
                <div class="p-5 border-t border-green-200 bg-green-50/50">
                    <h4 class="text-lg font-bold text-green-800 mb-2 border-b border-green-300 pb-1">C√°c B∆∞·ªõc Gi·∫£i:</h4>
                    <p id="solution-text" class="text-gray-800 text-lg leading-relaxed whitespace-pre-wrap"></p>
                </div>
            </details>
        </div>
        
    </div>

    <!-- QUIZ MODAL (POP UP FULL M√ÄN H√åNH - ƒê√É M·ªû R·ªòNG) -->
    <div id="quiz-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 hidden flex items-center justify-center p-4 transition-opacity duration-300">
        <!-- ƒê√£ ƒë·ªïi max-w-2xl th√†nh max-w-4xl v√† h-[90vh] th√†nh h-[95vh] -->
        <div class="bg-white rounded-xl w-full max-w-4xl p-6 md:p-10 relative h-[95vh] flex flex-col">
            <!-- Close Button -->
            <button id="close-quiz-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-3xl font-extrabold text-purple-700 text-center mb-6 border-b-2 border-purple-200 pb-3">Tr·∫Øc Nghi·ªám To√°n H·ªçc</h2>
            
            <!-- Quiz Content Area -->
            <div id="quiz-content" class="flex-grow overflow-y-auto">
                <!-- Loading/Quiz Content will go here -->
                <div id="quiz-loading" class="flex flex-col justify-center items-center h-full hidden">
                    <div class="loading-animation border-purple-500"></div>
                    <!-- C·∫≠p nh·∫≠t th√¥ng b√°o t·∫£i Quiz -->
                    <span class="mt-3 text-lg font-medium text-purple-600">ƒêang t√≠nh to√°n... Ch·ªâ v√†i gi√¢y n·ªØa th√¥i!</span>
                </div>

                <div id="quiz-question-area" class="hidden">
                    <!-- Question -->
                    <div class="mb-6 bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500 shadow-md">
                        <p class="text-lg font-semibold text-gray-700 mb-2 flex items-center space-x-2">
                             <span class="text-2xl">üí°</span>
                             <span>ƒê·ªÅ b√†i (M·ª©c: <span id="quiz-level" class="font-bold text-purple-600"></span>):</span>
                        </p>
                        <p id="quiz-problem-text" class="text-2xl font-serif text-gray-900 leading-snug"></p>
                    </div>

                    <!-- Choices -->
                    <div id="quiz-choices" class="space-y-4">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>

                <!-- Feedback Area -->
                <div id="quiz-feedback" class="mt-6 p-4 rounded-lg text-center font-bold text-xl hidden transition-all duration-300"></div>
            </div>

            <!-- Footer Button -->
            <div class="mt-6 border-t pt-4">
                <button id="quiz-next-btn" class="w-full px-6 py-3 bg-purple-600 text-white text-lg font-bold rounded-lg hover:bg-purple-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                    T·∫°o C√¢u H·ªèi M·ªõi
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // C√°c h·∫±ng s·ªë v√† bi·∫øn to√†n c·ª•c
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const apiKey = "AIzaSyCiHJhV9T26xfojNPqrQqvsRRfv1f5xrgU"; // API Key s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông cung c·∫•p trong m√¥i tr∆∞·ªùng Canvas
        const contextInput = document.getElementById('context-input');
        const generateBtn = document.getElementById('generate-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const statusMessage = document.getElementById('status-message');
        const resultArea = document.getElementById('result-area');
        const problemText = document.getElementById('problem-text');
        const solutionText = document.getElementById('solution-text');
        const currentLevelSpan = document.getElementById('current-level');
        const levelBadge = document.getElementById('level-badge');

        // Bi·∫øn v√† DOM cho Quiz
        const quizBtn = document.getElementById('quiz-btn');
        const quizModal = document.getElementById('quiz-modal');
        const closeQuizBtn = document.getElementById('close-quiz-btn');
        const quizLoading = document.getElementById('quiz-loading');
        const quizQuestionArea = document.getElementById('quiz-question-area');
        const quizProblemText = document.getElementById('quiz-problem-text');
        const quizChoicesDiv = document.getElementById('quiz-choices');
        const quizFeedback = document.getElementById('quiz-feedback');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizLevelSpan = document.getElementById('quiz-level');

        let selectedLevel = 'Bi·∫øt'; // M·ª©c ƒë·ªô m·∫∑c ƒë·ªãnh
        let selectedType = 'Th·ª±c t·∫ø'; // Lo·∫°i b√†i t·∫≠p m·∫∑c ƒë·ªãnh
        let isAnswered = false; // Tr·∫°ng th√°i ƒë√£ tr·∫£ l·ªùi c·ªßa Quiz hi·ªán t·∫°i

        // 1. C·∫•u h√¨nh c√°c m·ª©c ƒë·ªô kh√≥
        const levelConfigs = {
            "Bi·∫øt": {
                color: "bg-green-100 text-green-700",
                description: "T·ªïng v√† Hi·ªáu ƒë∆∞·ª£c cho r√µ r√†ng. T·∫≠p trung v√†o c√¥ng th·ª©c."
            },
            "Hi·ªÉu": {
                color: "bg-yellow-100 text-yellow-700",
                description: "T·ªïng ƒë∆∞·ª£c cho, Hi·ªáu ƒë∆∞·ª£c suy lu·∫≠n t·ª´ c√¢u so s√°nh tr·ª±c ti·∫øp."
            },
            "V·∫≠n d·ª•ng": {
                color: "bg-red-100 text-red-700",
                description: "T·ªïng ho·∫∑c Hi·ªáu (ho·∫∑c c·∫£ hai) ƒë∆∞·ª£c l·ªìng gh√©p trong t√¨nh hu·ªëng th·ª±c t·∫ø, ƒë√≤i h·ªèi ph√¢n t√≠ch."
            }
        };

        // 2. ƒê·ªãnh nghƒ©a c·∫•u tr√∫c JSON ƒë·∫ßu ra mong mu·ªën
        const problemResponseSchema = {
            type: "OBJECT",
            properties: {
                "problem": { "type": "STRING" },
                "solution_steps": { "type": "STRING" },
                "level": { "type": "STRING" }
            },
            propertyOrdering: ["problem", "solution_steps", "level"]
        };

        // 2b. ƒê·ªãnh nghƒ©a c·∫•u tr√∫c JSON ƒë·∫ßu ra mong mu·ªën cho QUIZ
        const quizResponseSchema = {
            type: "OBJECT",
            properties: {
                "problem": { "type": "STRING" },
                "choices": { 
                    "type": "ARRAY", 
                    "items": { "type": "STRING" },
                    "description": "4 ƒë√°p √°n tr·∫Øc nghi·ªám."
                },
                "correct_index": { "type": "INTEGER", "description": "Ch·ªâ m·ª•c (0-3) c·ªßa ƒë√°p √°n ƒë√∫ng." },
                "level": { "type": "STRING" }
            },
            propertyOrdering: ["problem", "choices", "correct_index", "level"]
        };
        
        /**
         * 3. H√†m t·∫°o System Instruction cho b√†i t·∫≠p Chi ti·∫øt
         */
        function createProblemSystemInstruction(level, context, type) {
            const levelPrompt = levelConfigs[level].description;
            
            let typeInstruction;
            let contextInstruction = "";

            if (type === "Th·ª±c t·∫ø") {
                typeInstruction = "ƒê·ªÅ b√†i PH·∫¢I l√† m·ªôt b√†i to√°n ƒë·ªë (word problem) ho√†n ch·ªânh, s·ª≠ d·ª•ng ng√¥n ng·ªØ ti·∫øng Vi·ªát chu·∫©n, th√¢n thi·ªán v·ªõi h·ªçc sinh.";
                contextInstruction = context ? `ƒê·ªÅ b√†i PH·∫¢I l·ªìng gh√©p ng·ªØ c·∫£nh sau: "${context}".` : "";
            } else { // Ph√©p t√≠nh
                // ƒê√É S·ª¨A: ƒê·∫£m b·∫£o ƒë·ªÅ b√†i y√™u c·∫ßu t√¨m m·ªôt gi√° tr·ªã c·ª• th·ªÉ ƒë·ªÉ ph√π h·ª£p v·ªõi format b√†i gi·∫£i
                typeInstruction = "ƒê·ªÅ b√†i PH·∫¢I l√† m·ªôt ph√©p t√≠nh/c√¢u h·ªèi tr·ª±c ti·∫øp, KH√îNG C√ì C√ÇU CHUY·ªÜN ƒê·ªê. V√≠ d·ª•: 'T√¨m s·ªë l·ªõn/s·ªë b√©, bi·∫øt t·ªïng X v√† hi·ªáu Y'.";
            }

            return `
                B·∫°n l√† m·ªôt chuy√™n gia t·∫°o ƒë·ªÅ b√†i to√°n ti·ªÉu h·ªçc (l·ªõp 4) t·∫°i Vi·ªát Nam theo ch∆∞∆°ng tr√¨nh SGK 2018.
                Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o m·ªôt b√†i to√°n DUY NH·∫§T V√Ä CHI TI·∫æT v·ªÅ ch·ªß ƒë·ªÅ "T√¨m hai s·ªë khi bi·∫øt T·ªïng v√† Hi·ªáu".
                
                Quy t·∫Øc:
                1. M·ª©c ƒë·ªô kh√≥: ${level} (${levelPrompt}).
                2. Lo·∫°i b√†i t·∫≠p: ${type}. ${typeInstruction}
                3. ${contextInstruction}
                4. Cung c·∫•p L·ªùi gi·∫£i chi ti·∫øt theo t·ª´ng b∆∞·ªõc gi·∫£i (T√≥m t·∫Øt, L·ªùi gi·∫£i, Ph√©p t√≠nh, ƒê√°p s·ªë) nh∆∞ m·ªôt gi√°o vi√™n.
                5. PH·∫¢I t·∫°o ra c√°c s·ªë li·ªáu h·ª£p l√Ω cho h·ªçc sinh ti·ªÉu h·ªçc (v√≠ d·ª•: t·ªïng kh√¥ng qu√° 1000, hi·ªáu kh√¥ng qu√° 500).
                
                PH·∫¢I tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON theo schema ƒë√£ cung c·∫•p.
            `.trim();
        }

        /**
         * 3b. H√†m t·∫°o System Instruction cho Quiz Tr·∫Øc nghi·ªám
         */
        function createQuizSystemInstruction(level, context, type) {
            const levelPrompt = levelConfigs[level].description;
            
            let typeInstruction;
            let contextInstruction = "";

            if (type === "Th·ª±c t·∫ø") {
                typeInstruction = "ƒê·ªÅ b√†i PH·∫¢I l√† m·ªôt b√†i to√°n ƒë·ªë (word problem) ho√†n ch·ªânh.";
                contextInstruction = context ? `ƒê·ªÅ b√†i PH·∫¢I l·ªìng gh√©p ng·ªØ c·∫£nh sau: "${context}".` : "";
            } else { // Ph√©p t√≠nh
                // ƒê√É S·ª¨A: ƒê·∫£m b·∫£o ƒë·ªÅ b√†i r√µ r√†ng, v√† ƒë√°p √°n l√† c√°c gi√° tr·ªã s·ªë h·ªçc (numeric)
                typeInstruction = "ƒê·ªÅ b√†i PH·∫¢I l√† c√¢u h·ªèi tr·ª±c ti·∫øp, KH√îNG C√ì C√ÇU CHUY·ªÜN ƒê·ªê. V√≠ d·ª•: 'T√¨m s·ªë l·ªõn/s·ªë b√©, bi·∫øt t·ªïng X v√† hi·ªáu Y'. C√°c ƒë√°p √°n (choices) PH·∫¢I l√† c√°c gi√° tr·ªã s·ªë h·ªçc ph√π h·ª£p v·ªõi c√¢u h·ªèi.";
            }

            return `
                B·∫°n l√† m·ªôt chuy√™n gia t·∫°o ƒë·ªÅ b√†i to√°n ti·ªÉu h·ªçc (l·ªõp 4) t·∫°i Vi·ªát Nam theo ch∆∞∆°ng tr√¨nh SGK 2018.
                Nhi·ªám v·ª• c·ªßa b·∫°n l√† t·∫°o m·ªôt B√ÄI TR·∫ÆC NGHI·ªÜM DUY NH·∫§T (quiz) v·ªÅ ch·ªß ƒë·ªÅ "T√¨m hai s·ªë khi bi·∫øt T·ªïng v√† Hi·ªáu".
                
                Quy t·∫Øc:
                1. M·ª©c ƒë·ªô kh√≥: ${level} (${levelPrompt}).
                2. Lo·∫°i b√†i t·∫≠p: ${type}. ${typeInstruction}
                3. ${contextInstruction}
                4. PH·∫¢I t·∫°o ra 4 ƒë√°p √°n TR·∫ÆC NGHI·ªÜM (Choices), trong ƒë√≥ ch·ªâ c√≥ M·ªòT ƒë√°p √°n ƒë√∫ng (correct_index 0-3).
                5. PH·∫¢I t·∫°o ra c√°c s·ªë li·ªáu h·ª£p l√Ω cho h·ªçc sinh ti·ªÉu h·ªçc (v√≠ d·ª•: t·ªïng kh√¥ng qu√° 1000, hi·ªáu kh√¥ng qu√° 500).
                
                PH·∫¢I tr·∫£ v·ªÅ k·∫øt qu·∫£ d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON theo schema ƒë√£ cung c·∫•p.
            `.trim();
        }
        
        /**
         * 4. H√†m x·ª≠ l√Ω logic g·ªçi API chung (Chi ti·∫øt v√† Quiz)
         */
        async function fetchContentWithBackoff(level, context, type, isQuiz) {
            let attempt = 0;
            const maxAttempts = 3;

            // Thi·∫øt l·∫≠p tr·∫°ng th√°i loading
            const loader = isQuiz ? quizLoading : loadingIndicator;
            const questionArea = isQuiz ? quizQuestionArea : resultArea;
            const schema = isQuiz ? quizResponseSchema : problemResponseSchema;
            const systemPromptFunc = isQuiz ? createQuizSystemInstruction : createProblemSystemInstruction;
            const userQueryPrefix = isQuiz ? "c√¢u h·ªèi tr·∫Øc nghi·ªám" : "b√†i to√°n chi ti·∫øt";

            loader.classList.remove('hidden');
            questionArea.classList.add('hidden');
            statusMessage.classList.add('hidden');

            // Qu·∫£n l√Ω tr·∫°ng th√°i n√∫t ri√™ng bi·ªát (ƒê√£ fix l·ªói)
            if (isQuiz) {
                quizNextBtn.disabled = true; 
            } else {
                generateBtn.disabled = true;
            }

            while (attempt < maxAttempts) {
                try {
                    const systemPrompt = systemPromptFunc(level, context, type);
                    const userQuery = `T·∫°o m·ªôt ${userQueryPrefix} To√°n Ti·ªÉu h·ªçc Vi·ªát Nam v·ªÅ ch·ªß ƒë·ªÅ T√¨m hai s·ªë khi bi·∫øt T·ªïng v√† Hi·ªáu ·ªü m·ª©c ƒë·ªô "${level}", lo·∫°i "${type}".`;

                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    };

                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const jsonString = candidate.content.parts[0].text;
                        const parsedData = JSON.parse(jsonString);
                        
                        if (isQuiz) {
                            displayQuiz(parsedData);
                        } else {
                            displayProblem(parsedData);
                        }
                        return; // Th√†nh c√¥ng, tho√°t v√≤ng l·∫∑p
                    } else {
                        throw new Error("API response was valid but content structure was empty or unexpected.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    attempt++;

                    if (attempt < maxAttempts) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000; // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Th·∫•t b·∫°i sau s·ªë l·∫ßn th·ª≠ t·ªëi ƒëa
                        statusMessage.textContent = "Kh√¥ng th·ªÉ t·∫°o b√†i t·∫≠p. Vui l√≤ng th·ª≠ l·∫°i sau.";
                        statusMessage.classList.remove('hidden');
                    }
                }
            }
            
            // ·∫®n loading v√† k√≠ch ho·∫°t l·∫°i n√∫t sau khi ho√†n th√†nh (ho·∫∑c th·∫•t b·∫°i)
            loader.classList.add('hidden');
            generateBtn.disabled = false; // Lu√¥n ƒë·∫£m b·∫£o n√∫t ch√≠nh ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i
            if (isQuiz) quizNextBtn.disabled = false;
        }

        /**
         * 5a. H√†m c·∫≠p nh·∫≠t giao di·ªán k·∫øt qu·∫£ b√†i t·∫≠p Chi ti·∫øt
         */
        function displayProblem(data) {
            const config = levelConfigs[data.level] || levelConfigs['Bi·∫øt'];
            currentLevelSpan.textContent = data.level;
            levelBadge.textContent = data.level;
            levelBadge.className = `px-3 py-1 text-sm font-semibold rounded-full ${config.color}`;
            
            problemText.textContent = data.problem;
            solutionText.textContent = data.solution_steps;

            resultArea.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            generateBtn.disabled = false;
        }

        /**
         * 5b. H√†m c·∫≠p nh·∫≠t giao di·ªán Quiz
         */
        function displayQuiz(data) {
            isAnswered = false;
            quizLoading.classList.add('hidden');
            quizQuestionArea.classList.remove('hidden');
            quizFeedback.classList.add('hidden');
            quizNextBtn.disabled = false;

            quizLevelSpan.textContent = data.level;
            quizProblemText.textContent = data.problem;
            quizChoicesDiv.innerHTML = '';

            const letters = ['A', 'B', 'C', 'D'];

            data.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                // Th√™m styling th√¢n thi·ªán h∆°n cho Quiz
                button.className = 'quiz-choice-btn w-full text-left p-4 rounded-xl border-2 border-purple-300 bg-purple-50 text-gray-800 font-bold transition duration-200 hover:bg-purple-300 hover:scale-[1.01] shadow-md';
                button.innerHTML = `<span class="font-extrabold mr-2">${letters[index]}.</span> ${choice}`;
                button.setAttribute('data-index', index);
                button.onclick = () => handleAnswer(button, index, data.correct_index);
                quizChoicesDiv.appendChild(button);
            });
            
            quizNextBtn.onclick = startQuiz;
        }

        /**
         * 5c. X·ª≠ l√Ω logic ch·ªçn ƒë√°p √°n
         */
        function handleAnswer(clickedButton, selectedIndex, correctIndex) {
            if (isAnswered) return;
            isAnswered = true;

            const allButtons = document.querySelectorAll('#quiz-choices .quiz-choice-btn');

            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-purple-300', 'hover:scale-[1.01]'); // Remove hover effects
                
                const index = parseInt(btn.getAttribute('data-index'));
                
                if (index === correctIndex) {
                    // ƒê√°p √°n ƒë√∫ng l√† m√†u xanh l√° ƒë·∫≠m
                    btn.classList.add('bg-green-600', 'text-white', 'font-extrabold', 'shadow-xl', 'border-green-800');
                    btn.classList.remove('bg-purple-50', 'bg-purple-200', 'border-purple-300', 'text-gray-800');
                } else if (index === selectedIndex) {
                    // ƒê√°p √°n sai l√† m√†u ƒë·ªè ƒë·∫≠m
                    btn.classList.add('bg-red-600', 'text-white', 'font-extrabold', 'shadow-xl', 'border-red-800');
                    btn.classList.remove('bg-purple-50', 'bg-purple-200', 'border-purple-300', 'text-gray-800');
                }
            });

            // Hi·ªÉn th·ªã ph·∫£n h·ªìi v·ªõi icon th√¢n thi·ªán
            quizFeedback.classList.remove('hidden');
            if (selectedIndex === correctIndex) {
                quizFeedback.className = 'mt-6 p-4 rounded-lg text-center font-extrabold text-2xl bg-green-100 text-green-700 transition-all duration-300 border-2 border-green-400 flex items-center justify-center space-x-2';
                quizFeedback.innerHTML = '<span>‚úÖ</span><span>Ch√≠nh x√°c! Ch√∫c m·ª´ng b·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c.</span>';
            } else {
                quizFeedback.className = 'mt-6 p-4 rounded-lg text-center font-extrabold text-2xl bg-red-100 text-red-700 transition-all duration-300 border-2 border-red-400 flex items-center justify-center space-x-2';
                const correctLetter = String.fromCharCode(65 + correctIndex);
                quizFeedback.innerHTML = `<span>‚ùå</span><span>Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√† ${correctLetter}. B·∫°n h√£y √¥n t·∫≠p l·∫°i nh√©!</span>`;
            }
        }

        /**
         * 6. Kh·ªüi t·∫°o v√† X·ª≠ l√Ω s·ª± ki·ªán
         */

        // H√†m kh·ªüi ƒë·ªông Quiz
        function startQuiz() {
            quizModal.classList.remove('hidden');
            const context = contextInput.value.trim();
            fetchContentWithBackoff(selectedLevel, context, selectedType, true);
        }

        // X·ª≠ l√Ω ch·ªçn m·ª©c ƒë·ªô (Level)
        document.querySelectorAll('.level-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.level-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                selectedLevel = e.target.dataset.level;
                e.target.classList.add('bg-indigo-600', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-700');
            });
        });

        // X·ª≠ l√Ω ch·ªçn lo·∫°i b√†i t·∫≠p (Type)
        document.querySelectorAll('.type-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.type-btn').forEach(btn => {
                    btn.classList.remove('bg-teal-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                selectedType = e.target.dataset.type;
                e.target.classList.add('bg-teal-600', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-700');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i Ng·ªØ c·∫£nh
                const isWordProblem = selectedType === "Th·ª±c t·∫ø";
                document.getElementById('context-input').placeholder = isWordProblem 
                    ? "V√≠ d·ª•: ·ªû trang tr·∫°i, v·ªÅ tr√≤ ch∆°i ƒëi·ªán t·ª≠, v·ªÅ ƒë·ªì v·∫≠t h·ªçc sinh..." 
                    : "Ng·ªØ c·∫£nh kh√¥ng √°p d·ª•ng cho Ph√©p t√≠nh B√¨nh th∆∞·ªùng.";
                document.querySelector('label[for="context-input"]').textContent = isWordProblem
                    ? "3. Nh·∫≠p Ng·ªØ C·∫£nh (Tu·ª≥ ch·ªçn - Ch·ªâ √°p d·ª•ng cho To√°n Th·ª±c T·∫ø):"
                    : "3. Nh·∫≠p Ng·ªØ C·∫£nh (Tu·ª≥ ch·ªçn - Kh√¥ng √°p d·ª•ng):";
                
                contextInput.disabled = !isWordProblem;
                if (!isWordProblem) {
                    contextInput.value = '';
                }
            });
        });


        // Ch·ªçn m·ª©c "Bi·∫øt" v√† lo·∫°i "Th·ª±c t·∫ø" m·∫∑c ƒë·ªãnh khi t·∫£i trang
        document.querySelector('[data-level="Bi·∫øt"]').click();
        document.querySelector('[data-type="Th·ª±c t·∫ø"]').click();


        // X·ª≠ l√Ω n√∫t T·∫°o B√†i T·∫≠p Chi ti·∫øt
        generateBtn.addEventListener('click', () => {
            const context = contextInput.value.trim();
            if (!selectedLevel || !selectedType) {
                statusMessage.textContent = "Vui l√≤ng ch·ªçn M·ª©c ƒë·ªô kh√≥ v√† Lo·∫°i b√†i t·∫≠p tr∆∞·ªõc khi t·∫°o.";
                statusMessage.classList.remove('hidden');
                return;
            }
            fetchContentWithBackoff(selectedLevel, context, selectedType, false);
        });

        // X·ª≠ l√Ω n√∫t T·∫°o Quiz
        quizBtn.addEventListener('click', startQuiz);

        // X·ª≠ l√Ω n√∫t ƒê√≥ng Quiz Modal (ƒê√É S·ª¨A L·ªñI 1)
        closeQuizBtn.addEventListener('click', () => {
            quizModal.classList.add('hidden');
            // ƒê·∫£m b·∫£o n√∫t t·∫°o b√†i t·∫≠p chi ti·∫øt ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i khi tho√°t quiz
            generateBtn.disabled = false; 
        });

        // 7. Thao t√°c Firebase (C·∫ßn thi·∫øt ƒë·ªÉ ·ª©ng d·ª•ng ch·∫°y trong Canvas)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("ƒê√£ ƒëƒÉng nh·∫≠p b·∫±ng token t√πy ch·ªânh.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("ƒê√£ ƒëƒÉng nh·∫≠p ·∫©n danh.");
                    }
                } catch (error) {
                    console.error("L·ªói x√°c th·ª±c Firebase:", error);
                }
            }
            authenticate();
        }
    </script>
</body>
</html>
